<!DOCTYPE HTML>
<html>
<head>
	<title>Lit Dark</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #FFF;
		}

		#loader{
    		/*background:green; */
    		width:848px;
    		height:480px;   
    		text-align: center;
		}
	</style>
	<script src="../bin/pixi.js"></script>

</head>
<body>

    <div id="loader" class="layer">
    	<br></br>
        <h3>Loading LIT Dark</h3>
        <img src="loading_transparent.gif" alt="loader" />     
    </div>

	<script>

//hide the URL bar
// When ready...
window.addEventListener("load",function() {
	// Set a timeout...
	setTimeout(function(){
		// Hide the address bar!
		window.scrollTo(0, 1);
	}, 0);
});


//https://github.com/kittykatattack/learningPixi#keyboard
function keyboard(keyCode) {
  var key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
    }
    event.preventDefault();
  };

  //The `upHandler`
  key.upHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
    }
    event.preventDefault();
  };

  //Attach event listeners
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}


//Keith Peter's Vector JS class
var vector2 = {
	_x: 1,
	_y: 0,

	create: function(x, y) {
		var obj = Object.create(this);
		obj.setX(x);
		obj.setY(y);
		return obj;
	},

	setX: function(value) {
		this._x = value;
	},

	getX: function() {
		return this._x;
	},

	setY: function(value) {
		this._y = value;
	},

	getY: function() {
		return this._y;
	},

	setAngle: function(angle) {
		var length = this.getLength();
		this._x = Math.cos(angle) * length;
		this._y = Math.sin(angle) * length;
	},

	getAngle: function() {
		return Math.atan2(this._y, this._x);
	},

	setLength: function(length) {
		var angle = this.getAngle();
		this._x = Math.cos(angle) * length;
		this._y = Math.sin(angle) * length;
	},

	getLength: function() {
		return Math.sqrt(this._x * this._x + this._y * this._y);
	},

	// add: function(v2) {
	// 	return vector2.create(this._x + v2.getX(), this._y + v2.getY());
	// },

	// subtract: function(v2) {
	// 	return vector2.create(this._x - v2.getX(), this._y - v2.getY());
	// },

	// multiply: function(val) {
	// 	return vector2.create(this._x * val, this._y * val);
	// },

	// divide: function(val) {
	// 	return vector2.create(this._x / val, this._y / val);
	// },

	addTo: function(v2) {
		this._x += v2.getX();
		this._y += v2.getY();
	},

	subtractFrom: function(v2) {
		this._x -= v2.getX();
		this._y -= v2.getY();
	},

	multiplyBy: function(val) {
		this._x *= val;
		this._y *= val;
	},

	divideBy: function(val) {
		this._x /= val;
		this._y /= val;
	},

	normalise: function() {
		var mag = this.getLength();
		this._x /= mag;
		this._y /= mag;	
	},

	toString: function(){
		return 'x: ' + this._x + '\ty: ' + this._y;
	}
};

var gameState = 'loading'; //'playing', 'gameOver', 'loading'
var gameLoop = null;

var lastUpdate = Date.now();

var AH_GLOBALS = { 
	SCREEN_W: 848,
	SCREEN_H: 480,
	PLAYER_SPEED: 1
};

var fontStyle = {
	align: 'center',
    font : '36px Arial bold italic',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 5,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 6,
    wordWrap : true,
    wordWrapWidth : 440
};

var scoreFontStyle = {
	align: 'center',
    font : '20px Arial bold italic',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 1,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 2,
    wordWrap : true,
    wordWrapWidth : 440
};

function onAssetsLoaded(){

	window.gameLoop = new GameLoop();
	//window.gameLoop.init();
	window.gameLoop.run();
	startGame();
	document.getElementById("loader").style.display = "none";
}

//LOAD ALL PRELOADED TEXTURES IN HERE
//////////////////////////////////////////////
function preloadTextures() {
	
	// create a new loader
	var loader = PIXI.loader;
	loader.add('player', 'player.png');
	// use callback
	loader.once('complete', onAssetsLoaded);
	//begin load
	loader.load();
}

function startGame() {		
	gameLoop.init();
	gameState = 'playing';
}

function playAgain() {
	startGame();
	window.blackHole.SetPos(new PIXI.Point(AH_GLOBALS.SCREEN_W/2, AH_GLOBALS.SCREEN_H/2));
}

function scaleSprite(sprite_){
	
	//commented out to remove scaling
	// sprite_.scale.x = window.innerHeight / AH_GLOBALS.SCREEN_H;
	// sprite_.scale.y = window.innerHeight / AH_GLOBALS.SCREEN_H;
}

function collisionManager(sprite1, sprite2)
{
	//find left, right, top and bottom of sprite1
	var l1 = sprite1.position.x - sprite1.width /2;
	var r1 = sprite1.position.x + sprite1.width /2;
	var t1 = sprite1.position.y + sprite1.height /2;
	var b1 = sprite1.position.y - sprite1.height /2;
	var l2 = sprite2.position.x - sprite2.width /2;
	var r2 = sprite2.position.x + sprite2.width /2;
	var t2 = sprite2.position.y + sprite2.height /2;
	var b2 = sprite2.position.y - sprite2.height /2;

	if (r1 < l2 || r2 < l1 || b1 > t2 || t1 < b2){
		return false;
	}
	return true;
}

function Timer() {
	var self = this;

	self.timer = 0.0;
	self.promptText = new PIXI.Text('Score: ', scoreFontStyle);
	self.promptText.position.set(10, 10);

	this.update = function(dt_) {
		self.timer += Math.floor(dt_ / 10);
		self.promptText.text = "Score: " + self.timer;
	}

	this.reset = function() {
		self.timer = 0.0;
	}
}




// function GameBackground(){
	
// 	this.backgroundMouseDown = function(event_) {
// 		window.blackHole.SetPos(event_.data.global);			
// 	}

// 	this.sprite = PIXI.Sprite.fromImage("sample_bg.png");
// 	this.sprite.position.set(0,0);
// 	this.sprite.interactive = true;
// 	this.sprite.on('mousedown', this.backgroundMouseDown);
// 	this.sprite.on('touchstart', this.backgroundMouseDown);

// 	//scale the sprite
// 	scaleSprite(this.sprite);
// }

function Player(){
	var self = this;

	this.sprite = PIXI.Sprite.fromImage("player.png");
	this.sprite.anchor.x = 0.5;
	this.sprite.anchor.y = 0.5;
	this.sprite.position.set(AH_GLOBALS.SCREEN_W/2, AH_GLOBALS.SCREEN_H/2 - 100);
	//this.sprite.interactive = true;
	//this.sprite.on('mousedown', this.playerMouseDown);	
	
	this.velocity = vector2.create(0,0);
	

	scaleSprite(this.sprite);

	//define keyObjects and listeners
	this.kN = keyboard(38);
	this.kS = keyboard(40);
	this.kE = keyboard(39);
	this.kW = keyboard(37);

	//NORTH
	this.kN.press = function() {
		self.velocity._y -= AH_GLOBALS.PLAYER_SPEED;
	}
	this.kN.release = function() {
		self.velocity._y += AH_GLOBALS.PLAYER_SPEED;
	}
	//SOUTH
	this.kS.press = function() {
		self.velocity._y += AH_GLOBALS.PLAYER_SPEED;
	}
	this.kS.release = function() {
		self.velocity._y -= AH_GLOBALS.PLAYER_SPEED;
	}	
	//EAST
	this.kE.press = function() {
		self.velocity._x += AH_GLOBALS.PLAYER_SPEED;
	}
	this.kE.release = function() {
		self.velocity._x -= AH_GLOBALS.PLAYER_SPEED;
	}	
	//WEST
	this.kW.press = function() {
		self.velocity._x -= AH_GLOBALS.PLAYER_SPEED;
	}
	this.kW.release = function() {
		self.velocity._x += AH_GLOBALS.PLAYER_SPEED;
	}	


	// this.playerMouseDown = function (){
	// 	console.log('playerMouseDown');
	// }

	this.update = function()
	{
		if ( gameState === 'playing'){ 

			self.sprite.position.x += this.velocity._x;
			self.sprite.position.y += this.velocity._y;;
			//self.sprite.rotation += 0.04;
		}
	}
}

function GameLoop(){

	var self = this;
	
	//create the renderer
	this.renderer = new PIXI.WebGLRenderer(AH_GLOBALS.SCREEN_W, AH_GLOBALS.SCREEN_H);//autoDetectRenderer(400, 300);

	//add it to the DOM body
	document.body.appendChild(this.renderer.view);

	//create a stage (all sprites added to this)
	self.stage = new PIXI.Container();

	this.init = function(){
		console.log("init");

		self.player = new Player();

		self.promptText = new PIXI.Text('LITDark Click To Play', fontStyle);

		self.promptText.interactive = true;
		self.promptText.on('mousedown', playAgain);	
		self.promptText.on('touchstart', playAgain);	
		self.promptText.position.set(AH_GLOBALS.SCREEN_W/2, AH_GLOBALS.SCREEN_H/2);
		self.promptText.anchor.x = 0.5;
		self.promptText.anchor.y = 0.5;
		
		//self.stage.addChild(this.gameBG.sprite);
		//self.stage.addChild(window.blackHole.sprite);
		self.stage.addChild(this.player.sprite);
		//self.stage.addChild(self.timer.promptText);
		//self.stage.removeChild(self.loadingText);
	}

	// this.spawnEnemy = function(){
	// 	console.log("spawnEnemy");
	// 	//every 2 seconds add an enemy
	// 	var newEnemy = new Enemy();
	// 	self.enemyList.push(newEnemy);
	// 	self.stage.addChild(newEnemy.sprite);
	// }

	this.run = function() {
		requestAnimationFrame( this.animate );
	}

	this.animate = function(){

		//calc delta
		var now = Date.now();
		var dt = now - lastUpdate;
		lastUpdate = now;

		if ( gameState === 'playing') {
    		self.player.update();

			// if ( collisionManager( self.player.sprite, self.enemyList[i].sprite) ) {
		   	//  			console.log('collision with enemy');
		   	//  			gameState = 'gameOver';	    			
		   	//	}
			
			
    	}
    	if  ( gameState === 'gameOver') {
    		self.stage.addChild(self.promptText);
    		gameState = 'mainMenu';
    	}
    	
    	self.renderer.render(self.stage);
		
		requestAnimationFrame( self.animate );
	}
}

preloadTextures();

	</script>

	</body>
</html>
