<!DOCTYPE HTML>
<html>
<head>
	<title>LD 33 Entry - Javier Munoz and Adam Hulbert</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #FFF;
		}

		#loader{
    		/*background:green; */
    		width:640px;
    		height:360px;   
    		text-align: center;
		}
	</style>
	<script src="../bin/pixi.js"></script>

</head>
<body>

    <div id="loader" class="layer">
    	<br></br>
        <h3>Loading LD 33 Entry - Javier Munoz and Adam Hulbert</h3>
        <img src="loading_transparent.gif" alt="loader" />     
    </div>

    <script src="keyboard.js"></script>

	<script>

//hide the URL bar
// When ready...
window.addEventListener("load",function() {
	// Set a timeout...
	setTimeout(function(){
		// Hide the address bar!
		window.scrollTo(0, 1);
	}, 0);
});

//Keith Peter's Vector JS class
var vector2 = {
	_x: 1,
	_y: 0,

	create: function(x, y) {
		var obj = Object.create(this);
		obj.setX(x);
		obj.setY(y);
		return obj;
	},

	setX: function(value) {
		this._x = value;
	},

	getX: function() {
		return this._x;
	},

	setY: function(value) {
		this._y = value;
	},

	getY: function() {
		return this._y;
	},

	setAngle: function(angle) {
		var length = this.getLength();
		this._x = Math.cos(angle) * length;
		this._y = Math.sin(angle) * length;
	},

	getAngle: function() {
		return Math.atan2(this._y, this._x);
	},

	setLength: function(length) {
		var angle = this.getAngle();
		this._x = Math.cos(angle) * length;
		this._y = Math.sin(angle) * length;
	},

	getLength: function() {
		return Math.sqrt(this._x * this._x + this._y * this._y);
	},

	// add: function(v2) {
	// 	return vector2.create(this._x + v2.getX(), this._y + v2.getY());
	// },

	// subtract: function(v2) {
	// 	return vector2.create(this._x - v2.getX(), this._y - v2.getY());
	// },

	// multiply: function(val) {
	// 	return vector2.create(this._x * val, this._y * val);
	// },

	// divide: function(val) {
	// 	return vector2.create(this._x / val, this._y / val);
	// },

	addTo: function(v2) {
		this._x += v2.getX();
		this._y += v2.getY();
	},

	subtractFrom: function(v2) {
		this._x -= v2.getX();
		this._y -= v2.getY();
	},

	multiplyBy: function(val) {
		this._x *= val;
		this._y *= val;
	},

	divideBy: function(val) {
		this._x /= val;
		this._y /= val;
	},

	normalise: function() {
		var mag = this.getLength();
		this._x /= mag;
		this._y /= mag;	
	},

	toString: function(){
		return 'x: ' + this._x + '\ty: ' + this._y;
	}
};

var gameState = 'loading'; //'playing', 'gameOver', 'loading'
var gameLoop = null;

var lastUpdate = Date.now();

var AH_GLOBALS = { 
	SCREEN_W: 848,
	SCREEN_H: 480,
	MAX_SPEED: 3.5,
	ACCELLERATION: 0.15,
	TIME_STEP: 30
};

var fontStyle = {
	align: 'center',
    font : '36px Arial bold italic',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 5,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 6,
    wordWrap : true,
    wordWrapWidth : 440
};

var scoreFontStyle = {
	align: 'center',
    font : '20px Arial bold italic',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 1,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 2,
    wordWrap : true,
    wordWrapWidth : 440
};

function onAssetsLoaded(){

	window.gameLoop = new GameLoop();
	window.gameLoop.init();
	window.gameLoop.run();
	startGame();
	document.getElementById("loader").style.display = "none";
}

function preloadTextures() {
	
	// create a new loader
	var loader = PIXI.loader;
	loader.add('player', 'player.png');
	// use callback
	loader.once('complete', onAssetsLoaded);
	//begin load
	loader.load();
}

function startGame() {		
	//gameLoop.init();
	gameState = 'playing';
}

function playAgain() {
	startGame();
	window.blackHole.SetPos(new PIXI.Point(AH_GLOBALS.SCREEN_W/2, AH_GLOBALS.SCREEN_H/2));
}

function scaleSprite(sprite_){
	
	//commented out to remove scaling
	// sprite_.scale.x = window.innerHeight / AH_GLOBALS.SCREEN_H;
	// sprite_.scale.y = window.innerHeight / AH_GLOBALS.SCREEN_H;
}

function collisionManager(sprite1, sprite2)
{
	//find left, right, top and bottom of sprite1
	var l1 = sprite1.position.x - sprite1.width /2;
	var r1 = sprite1.position.x + sprite1.width /2;
	var t1 = sprite1.position.y + sprite1.height /2;
	var b1 = sprite1.position.y - sprite1.height /2;
	var l2 = sprite2.position.x - sprite2.width /2;
	var r2 = sprite2.position.x + sprite2.width /2;
	var t2 = sprite2.position.y + sprite2.height /2;
	var b2 = sprite2.position.y - sprite2.height /2;

	if (r1 < l2 || r2 < l1 || b1 > t2 || t1 < b2){
		return false;
	}
	return true;
}

function Player(){
	var self = this;

	self.groundYPos = AH_GLOBALS.SCREEN_H/2;

	self.sprite = PIXI.Sprite.fromImage("player.png");
	self.sprite.anchor.x = 0.5;
	self.sprite.anchor.y = 0.5;
	self.sprite.position.set(AH_GLOBALS.SCREEN_W/2, self.groundYPos);
	self.sprite.interactive = true;
	self.sprite.on('mousedown', this.playerMouseDown);	
	
	scaleSprite(this.sprite);

	self.velocity = vector2.create(0,0);
	self.direction = vector2.create(0,0);
	self.onGround = true;

	self.kN = keyboard(38);
	self.kS = keyboard(40);
	self.kE = keyboard(39);
	self.kW = keyboard(37);

	this.kN.press = function() {
		console.log('KN Pressed');

		if (self.onGround === true){
			self.velocity._y = -15;
			self.onGround = false;
		}
	}

	this.kN.release = function() {				
		console.log('KN Released');
	}

	this.playerMouseDown = function (){
		console.log('playerMouseDown');
	}

	this.update = function()
	{
		if ( gameState === 'playing'){ 

			self.sprite.position.x += self.velocity.getX();
			self.sprite.position.y += self.velocity.getY();

			//apply gravity if not on ground
			if ( self.onGround === false ){
				self.velocity._y += 1;
				if ( self.sprite.position.y >= self.groundYPos )
				{
					console.log('collided with ground');
					self.sprite.position.y = self.groundYPos;
					self.onGround = true;
					self.velocity._y = 0;
				}
			}
		}
	}
}


function GameLoop(){

	var self = this;
	
	//create the renderer
	this.renderer = new PIXI.WebGLRenderer(AH_GLOBALS.SCREEN_W, AH_GLOBALS.SCREEN_H);//autoDetectRenderer(400, 300);
	this.renderer.backgroundColor = 0xE0F0FF;

	//add it to the DOM body
	document.body.appendChild(this.renderer.view);

	//create a stage (all sprites added to this)
	self.stage = new PIXI.Container();

	this.init = function(){
		console.log("init");
		console.log(AH_GLOBALS.TIME_STEP);

		self.player = new Player();
		//self.timer = new Timer();
		self.promptText = new PIXI.Text('Game Over - Tap To Start Again', fontStyle);

		self.promptText.interactive = true;
		self.promptText.on('mousedown', playAgain);	
		self.promptText.on('touchstart', playAgain);	
		self.promptText.position.set(AH_GLOBALS.SCREEN_W/2, AH_GLOBALS.SCREEN_H/2);
		self.promptText.anchor.x = 0.5;
		self.promptText.anchor.y = 0.5;
		self.stage.addChild(this.player.sprite);
		//self.stage.addChild(self.timer.promptText);
	}


	this.run = function() {
		self.timeSinceAnimate = 0.0;
		requestAnimationFrame( this.animate );
	}

	this.animate = function(){

		//calc delta
		var now = Date.now();
		var dt = now - lastUpdate;
		lastUpdate = now;

		//fixed update step (30FPS)
		self.timeSinceAnimate += dt;

		//console.log(self.timeSinceAnimate);
		if ( gameState === 'playing' && self.timeSinceAnimate > AH_GLOBALS.TIME_STEP) {
			self.timeSinceAnimate -= AH_GLOBALS.TIME_STEP;

			//if program is not keeping up report it
			if (self.timeSinceAnimate > AH_GLOBALS.TIME_STEP )
			{
				console.log('PROGRAM IS NOT KEEPING UP WITH TIMESTEP (IGNORE ON STARTUP)!');
			}
			
    		self.player.update();

			for (i in self.enemyList){	    		
				self.enemyList[i].update();

				if ( collisionManager( self.player.sprite, self.enemyList[i].sprite) ) {
	    			console.log('collision with enemy');
	    			gameState = 'gameOver';	    			
	    		}
			}
    	}
    	if  ( gameState === 'gameOver') {
    		self.stage.addChild(self.promptText);
    		gameState = 'mainMenu';
    	}
    	
    	self.renderer.render(self.stage);
		
		requestAnimationFrame( self.animate );
	}
}

preloadTextures();

	</script>

	</body>
</html>
